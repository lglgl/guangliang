```
说明：
1、除kafka外，均运行在docker。
2、因kafka没有官方docker版本，没找到可靠的非官方3.4.0版本，暂时用官网安装包直接部署。
nohup ./bin/kafka-server-start.sh config/server.properties &
```



## 版本情况

| 名称          | 当前版本                     | 升级版本             |
| ------------- | ---------------------------- | -------------------- |
| Mysql         | 5.7.37                       | 8.0.32               |
| zookeeper     | 3.4.14                       | 3.7.1                |
| kafka         | 2.12                         | 3.4.0                |
| redis         | 5.0.3                        | 7.0.11               |
| es            | 6.8.12                       | 7.15.2               |
| Minio文件服务 | RELEASE.2022-06-11T19-55-32Z | 2023-05-04T21-44-30Z |
| Nacos         | 2.1.0                        | 2.1.1                |
| Nginx         | 1.22.1                       | 1.24.0               |

### docker部署

命名规则：dev-中间件-standalone/cluster-01

挂载规则：宿主机/usr/local/docker_data/中间件/源目录：/源目录

​					例：`/usr/local/docker_data/zookeeper/data: /data`

## 部署程序

### 1.Elasticsearch

执行代码：

```shell
#清空/usr/local/docker_data/elasticsearch/data
rm -rf /usr/local/docker_data/elasticsearch/data/*

docker run -it \
--name dev-es-standalone-01 \
--restart=always \
-v /usr/local/docker_data/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
-v /usr/local/docker_data/elasticsearch/data:/usr/share/elasticsearch/data \
-v /usr/local/docker_data/elasticsearch/plugins:/usr/share/elasticsearch/plugins \
-p 9200:9200 \
-p 9300:9300 \
-e ES_JAVA_OPTS="-Xms512m -Xmx1024m" \
-e "discovery.type=single-node" \
docker.elastic.co/elasticsearch/elasticsearch:7.15.2


```

修改密码

```
[root@idszt-dev ~]# docker exec -it dev-es-standalone-01 /bin/bash
bash-4.4# bin/elasticsearch-setup-passwords interactive
Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.
You will be prompted to enter passwords as the process progresses.
Please confirm that you would like to continue [y/N]y
```





kibana

```
docker run -d --name dev-kibana-standalone-01  -p 5601:5601 -e "ELASTICSEARCH_HOSTS=http://119.23.155.163:9200/" docker.elastic.co/kibana/kibana:7.15.2

docker exec -it dev-kibana-standalone-01 /bin/bash		# 进入容器内部
cat /usr/share/kibana/config/kibana.yml


# Default Kibana configuration for docker target
server.host: "0"
server.shutdownTimeout: "5s"
elasticsearch.hosts: [ "http://elasticsearch:9200" ]
monitoring.ui.container.elasticsearch.enabled: true

i18n.locale: zh-CN
#elasticsearch.username: elastic
#elasticsearch.password: szt@#es

```



### 2.MySQL

```
1、docker部署MySQL带密码时，有可能由于客户端字符编码不一致，导致无法进入内部环境修改root密码和开发访问权限，因而使用无密码启动后，修改密码。
2、MySQL8配置文件路径相对于MySQL5.7有所变动，由/etc/mysql/config变到/etc/conf.d，需同步调整。
3、安装后调整字符集编码，在容器内/root/my.cnf文件。
```



1、设置无密码启动

```
docker run --name dev-mysql-standalone-01 -p 3309:3306 -d \
-e MYSQL_ALLOW_EMPTY_PASSWORD=yes   \
-v /usr/local/docker_data/mysql8/var/lib/mysql:/var/lib/mysql \
-v /usr/local/docker_data/mysql8/etc/my.cnf:/etc/my.cnf \
-v /usr/local/docker_data/mysql8/var/log/mysql:/var/log/mysql mysql:8.0.32
```

2、修改密码

```
docker exec -it dev-mysql-standalone-01 /bin/bash
mysql -uroot -pszt@#123
use mysql;
update user set host = '%' where user ='root';
flush privileges;
quit;
```

3、启动停止

```shell
docker stop dev-mysql-standalone-01
docker start dev-mysql-standalone-01

重新安装需执行#修改字符集，
docker cp  /etc/my.cnf dev-mysql-standalone-01:/etc/my.cnf
```

4、改字符集

```
#MySQL8的配置文件相对于MySQL5.7有变动
/root/mysql/config:/etc/mysql/conf.d

#修改字符集，
docker cp  /etc/my.cnf dev-mysql-standalone-01:/etc/my.cnf
-----------------------/etc/my.cnf文件--------------------------------------
[mysqld]
skip-host-cache
skip-name-resolve
datadir=/var/lib/mysql
socket=/var/run/mysqld/mysqld.sock
secure-file-priv=/var/lib/mysql-files
user=mysql
pid-file=/var/run/mysqld/mysqld.pid
#增加下面两行
character-set-server=utf8mb4
collation-server=utf8mb4_general_ci
default-time-zone = +08:00

[client]
socket=/var/run/mysqld/mysqld.sock
#增加下面一行
default-character-set = utf8mb4

!includedir /etc/mysql/conf.d/
```



### 3.Zookeeper

安装新版本（端口+1）

```
mkdir -p /usr/local/docker_data/zookeeper371/conf
mkdir -p /usr/local/docker_data/zookeeper371/data
mkdir -p /usr/local/docker_data/zookeeper371/datalog

# /etc/localtime为系统时区，无需修改挂在路径
docker run --name dev-zookeeper-standalone-01 \
-p 2181:2181 \
-v /usr/local/docker_data/zookeeper/conf:/conf \
-v /usr/local/docker_data/zookeeper/data:/data \
-v /usr/local/docker_data/zookeeper/datalog:/datalog \
-v /etc/localtime:/etc/localtime \
--restart=always \
--privileged=true \
-d zookeeper:3.7.1
```



### 4.Minio

不能直接升级，需要迁移数据

```
docker pull minio/minio:RELEASE.2023-05-04T21-44-30Z

docker run  --name dev-minio-standalone-03 -p 9000:9000 -p 9001:9001  \
 --restart=always \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=szt@#minio" \
  -v /usr/local/docker_data/minio2023/data:/data \
  -v /usr/local/docker_data/minio2023/config:/root/.minio \
  minio/minio:RELEASE.2023-05-04T21-44-30Z server /data  --console-address "0.0.0.0:9000" --address ":9001"
  


  
  -p 9001:9000 119.23.155.163:
   --console-address "0.0.0.0:9000" --address ":9001"

```



### 5.Nacos

版本变动不大，依赖的MySQL数据库结构需要升级

1、下载对应数据库建库SQL文件

```
MySQL8：https://raw.githubusercontent.com/alibaba/nacos/develop/distribution/conf/mysql-schema.sql
```

2、导入数据库

3、配置application.properties文件

```
#*************** Config Module Related Configurations ***************#
### If use MySQL as datasource:
spring.datasource.platform=mysql

### Count of DB:
db.num=1

### Connect URL of DB:
db.url.0=jdbc:mysql://119.23.155.163:3309/nacos?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useUnicode=true&useSSL=false&serverTimezone=UTC
db.user.0=root
db.password.0=s***3

### 修改server.tomcat.basedir为以下，否则会报错。
server.tomcat.basedir=/

```

4、运行启动

```shell
docker run -d --name dev-nacos-standalone-01 -p 8848:8848 \
--privileged=true -e JVM_XMS=512m -e JVM_XMX=512m -e MODE=standalone \
-v /usr/local/docker_data/nacos/logs:/home/nacos/logs \
-v /usr/local/docker_data/nacos/conf/application.properties:\
/home/nacos/conf/application.properties nacos/nacos-server:v2.1.1
```



### 6.Redis

```
docker run --restart=always \
-p 6379:6379 \
--name dev-redis-standalone-01 \
-v /usr/local/docker_data/redis/conf/redis.conf:/etc/redis/redis.conf \
-v /usr/local/docker_data/redis/data:/data \
-d redis:7.0.11 redis-server /etc/redis/redis.conf  \
--appendonly yes  \
--requirepass s***s

```



### 7.Kafka

```
docker pull wurstmeister/kafka:2.13-2.8.1

docker run --name dev-kafka-standalone-01 \
-p 9092:9092 \
-e KAFKA_BROKER_ID=0 \
-e KAFKA_ZOOKEEPER_CONNECT=119.23.155.163:2181/kafka \
-e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://119.23.155.163:9092 \
-e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \
-e KAFKA_HEAP_OPTS="-Xmx512m -Xms256m" \
-v /etc/localtime:/etc/localtime \
-e TZ='Asia/Shanghai' \
-e LANG="en_US.UTF-8" \
-v /usr/local/docker_data/kafka:/kafka \
-v /var/run/docker.sock:/var/run/docker.sock \
-d wurstmeister/kafka:2.13-2.8.1
```

